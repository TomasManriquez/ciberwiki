---
import Layout from "../layouts/Layout.astro";
import Navigation from "../components/Navigation.astro";
import Modal from "../components/Modal.astro";
import DropdownMenu from "../components/DropdownMenu.astro";

import { serverFetch } from "../utils/api";

// API_URL handled by serverFetch

let controls = [];
let standards = [];
let error = null;

try {
    const response = await serverFetch(Astro, "/api/controls");
    if (response.ok) {
        controls = await response.json();
    } else {
        error = "Failed to fetch controls";
    }

    // Fetch standards for the dropdown
    const standardsResponse = await serverFetch(Astro, "/api/standards");
    if (standardsResponse.ok) {
        standards = await standardsResponse.json();
    }
} catch (e) {
    error = "API connection failed";
}
---

<Layout title="Controls - Allware Wiki">
    <div class="pt-6 md:pt-8 pb-16 min-h-screen px-4 md:px-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div
                class="mb-8 md:mb-12 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
            >
                <div>
                    <h1
                        class="text-3xl md:text-5xl font-bold text-gradient mb-2 md:mb-4"
                    >
                        Controls
                    </h1>
                    <p class="text-base md:text-xl text-slate-400">
                        Monitor and update control status
                    </p>
                </div>
                <button
                    class="btn-primary w-full sm:w-auto active:scale-95 transition-transform"
                    id="openCreateModal"
                >
                    <svg
                        class="w-5 h-5 inline-block mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Control
                </button>
            </div>

            {
                error ? (
                    <div class="glass-card p-6 md:p-8 border-red-500/50">
                        <div class="flex items-center space-x-3">
                            <svg
                                class="w-6 h-6 text-red-400 flex-shrink-0"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <span class="text-red-400">{error}</span>
                        </div>
                    </div>
                ) : (
                    <div class="grid gap-4 md:gap-6">
                        {controls.map((control: any) => (
                            <a
                                href={`/controls/${control.id}`}
                                class="glass-card p-4 md:p-6 hover:bg-slate-800/60 transition-colors cursor-pointer block relative"
                            >
                                <div class="flex flex-col sm:flex-row items-start justify-between gap-4">
                                    <div class="flex items-start space-x-3 md:space-x-4 flex-1 min-w-0">
                                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <span class="text-blue-400 font-bold text-sm md:text-base">
                                                {control.code}
                                            </span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-lg md:text-xl font-bold mb-1">
                                                {control.title}
                                            </h3>
                                            <p class="text-slate-400 text-sm mb-3 line-clamp-2">
                                                {control.description ||
                                                    "No description"}
                                            </p>
                                            <div class="flex flex-wrap items-center gap-2 md:gap-3">
                                                <span
                                                    class={`badge text-xs ${
                                                        control.status ===
                                                        "completed"
                                                            ? "badge-success"
                                                            : control.status ===
                                                                "in-progress"
                                                              ? "badge-warning"
                                                              : "bg-slate-700 text-slate-400 border-slate-600"
                                                    }`}
                                                >
                                                    {control.status ||
                                                        "Pending"}
                                                </span>
                                                <span class="text-xs text-slate-500">
                                                    Updated{" "}
                                                    {control.createdAt
                                                        ? new Date(
                                                              control.createdAt *
                                                                  1000,
                                                          ).toLocaleDateString()
                                                        : "N/A"}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex space-x-2 w-full sm:w-auto">
                                        <DropdownMenu
                                            itemId={control.id}
                                            itemType="control"
                                            onDelete="deleteControl"
                                        />
                                    </div>
                                </div>
                            </a>
                        ))}

                        {controls.length === 0 && !error && (
                            <div class="glass-card p-8 md:p-12 text-center">
                                <svg
                                    class="w-12 h-12 md:w-16 md:h-16 text-slate-600 mx-auto mb-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                                    />
                                </svg>
                                <h3 class="text-lg md:text-xl font-semibold text-slate-400 mb-2">
                                    No controls found
                                </h3>
                                <p class="text-slate-500 mb-6">
                                    Create controls to start tracking compliance
                                </p>
                                <button class="btn-primary active:scale-95 transition-transform">
                                    Create First Control
                                </button>
                            </div>
                        )}
                    </div>
                )
            }
        </div>
    </div>

    <Modal id="createControlModal" title="Add New Control">
        <form id="createControlForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1">
                    Standard *
                </label>
                <select name="standardId" required class="input-field">
                    <option value="">Select a standard...</option>
                    {
                        standards.map((standard: any) => (
                            <option value={standard.id}>
                                {standard.name}{" "}
                                {standard.version
                                    ? `(${standard.version})`
                                    : ""}
                            </option>
                        ))
                    }
                </select>
                {
                    standards.length === 0 && (
                        <p class="text-xs text-amber-400 mt-1">
                            ⚠️ No standards available. Create a standard first.
                        </p>
                    )
                }
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1"
                    >Control Code</label
                >
                <input
                    type="text"
                    name="code"
                    required
                    class="input-field"
                    placeholder="e.g. 1.1"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1"
                    >Title</label
                >
                <input
                    type="text"
                    name="title"
                    required
                    class="input-field"
                    placeholder="Control Title"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1"
                    >Description</label
                >
                <textarea
                    name="description"
                    rows="3"
                    class="input-field"
                    placeholder="Control Description"></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="window.closeModal_createControlModal()"
                    >Cancel</button
                >
                <button type="submit" class="btn-primary">Create Control</button
                >
            </div>
        </form>
    </Modal>
</Layout>

<script>
    const API_URL = "http://localhost:3000";

    // Toast helper
    function showToast(message: string, icon = "✅") {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");
        const toastIcon = document.getElementById("toast-icon");

        if (toast && toastMessage && toastIcon) {
            toastMessage.textContent = message;
            toastIcon.textContent = icon;
            toast.classList.remove("translate-y-20", "opacity-0");

            setTimeout(() => {
                toast.classList.add("translate-y-20", "opacity-0");
            }, 3000);
        }
    }

    // Open Modal Handler
    const openBtn = document.getElementById("openCreateModal");
    if (openBtn) {
        openBtn.addEventListener("click", () => {
            const openModalFn = (window as any).openModal_createControlModal;
            if (typeof openModalFn === "function") {
                openModalFn();
            }
        });
    }

    // Delete control
    (window as any).deleteControl = async (id: string) => {
        if (
            !confirm(
                "Are you sure you want to delete this control? This action cannot be undone.",
            )
        ) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/controls/${id}`, {
                method: "DELETE",
            });

            if (response.ok) {
                showToast("Control deleted successfully", "✅");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const err = await response.json();
                showToast(err.error || "Failed to delete control", "❌");
            }
        } catch (error) {
            console.error("Error:", error);
            showToast("Connection error", "❌");
        }
    };

    // Form Submit Handler
    const form = document.getElementById(
        "createControlForm",
    ) as HTMLFormElement;
    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement;
            const originalText = submitBtn?.textContent || "Create Control";

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Creating...";
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_URL}/api/controls`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    showToast("Control created successfully", "✅");
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const err = await response.json();
                    showToast(err.error || "Failed to create control", "❌");
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("Connection error", "❌");
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        });
    }
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
