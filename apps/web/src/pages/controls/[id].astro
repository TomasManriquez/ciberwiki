---
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
    const API_URL = "http://localhost:3000";
    
    try {
        const response = await fetch(`${API_URL}/api/controls`);
        if (!response.ok) {
            return [];
        }
        
        const controls = await response.json();
        
        return controls.map((control: any) => ({
            params: { id: control.id },
        }));
    } catch (error) {
        console.error('Error fetching controls for static paths:', error);
        return [];
    }
}

const { id } = Astro.params;
const API_URL = "http://localhost:3000";

let control: any = null;
let evidence: any[] = [];
let error: string | null = null;

try {
    // Fetch control details
    const controlResponse = await fetch(`${API_URL}/api/controls/${id}`);
    if (controlResponse.ok) {
        control = await controlResponse.json();
        
        // Fetch evidence for this control
        const evidenceResponse = await fetch(`${API_URL}/api/evidence/control/${id}`);
        if (evidenceResponse.ok) {
            evidence = await evidenceResponse.json();
        }
    } else {
        error = "Control not found";
    }
} catch (e) {
    error = "Failed to load control";
}

const statusColors: Record<string, string> = {
    completed: 'bg-green-500/20 text-green-400 border-green-500/30',
    'in-progress': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
    pending: 'bg-slate-700 text-slate-400 border-slate-600',
};

const categoryIcons: Record<string, string> = {
    DOCUMENT: 'üìò',
    CONFIGURATION: 'üõ°Ô∏è',
    PROCESS: 'üìä',
};
---

<Layout title={control ? `Control ${control.code}` : "Control"}>
    <div class="pt-6 md:pt-8 pb-16 min-h-screen px-4 md:px-6">
        <div class="max-w-5xl mx-auto">
            {error ? (
                <div class="glass-card p-6 md:p-8 border-red-500/50">
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-red-400">{error}</span>
                    </div>
                </div>
            ) : control && (
                <>
                    <!-- Header -->
                    <div class="mb-8">
                        <a href="/controls" class="text-purple-400 hover:text-purple-300 text-sm mb-4 inline-flex items-center gap-2">
                            ‚Üê Back to Controls
                        </a>
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mt-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-blue-400 font-mono text-sm md:text-base font-bold">{control.code}</span>
                                    <span class={`badge text-xs ${statusColors[control.status] || statusColors.pending}`}>
                                        {control.status || 'pending'}
                                    </span>
                                </div>
                                <h1 class="text-2xl md:text-4xl font-bold mb-3">{control.title}</h1>
                                <p class="text-slate-400 text-sm md:text-base">{control.description}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Evidence Section -->
                    <div class="glass-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                            <h2 class="text-xl md:text-2xl font-bold">Evidencias Vinculadas</h2>
                            <a href={`/evidence?controlId=${id}`} class="btn-primary text-sm active:scale-95 transition-transform">
                                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Evidence
                            </a>
                        </div>

                        {evidence.length === 0 ? (
                            <div class="text-center py-12">
                                <svg class="w-12 h-12 md:w-16 md:h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-slate-500 text-sm md:text-base">No evidence linked to this control yet</p>
                            </div>
                        ) : (
                            <div class="space-y-3">
                                {evidence.map((item: any) => (
                                    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 hover:bg-slate-800/70 transition-colors">
                                        <div class="flex items-start gap-3">
                                            <span class="text-2xl flex-shrink-0">{categoryIcons[item.category] || 'üìÑ'}</span>
                                            <div class="flex-1 min-w-0">
                                                <h3 class="font-semibold text-white mb-1">{item.name}</h3>
                                                <p class="text-slate-400 text-sm mb-2 line-clamp-2">{item.description || 'No description'}</p>
                                                {item.contextNote && (
                                                    <div class="bg-slate-900/50 border border-slate-700/50 rounded p-2 mt-2">
                                                        <p class="text-xs text-slate-400">
                                                            <span class="font-semibold text-slate-300">Context:</span> {item.contextNote}
                                                        </p>
                                                    </div>
                                                )}
                                                <div class="flex flex-wrap items-center gap-2 mt-2">
                                                    <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">
                                                        {item.category}
                                                    </span>
                                                    {item.contentType === 'TEXT' && (
                                                        <span class="text-xs text-slate-500">‚úçÔ∏è Text</span>
                                                    )}
                                                </div>
                                            </div>
                                            {item.fileUrl && (
                                                <a 
                                                    href={item.fileUrl} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    class="btn-secondary text-xs py-1.5 px-3 whitespace-nowrap active:scale-95 transition-transform"
                                                >
                                                    View File
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <!-- Control Metadata -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                        <div class="glass-card p-4">
                            <h3 class="text-sm text-slate-500 mb-1">Assigned To</h3>
                            <p class="text-white">{control.assignedTo || 'Unassigned'}</p>
                        </div>
                        <div class="glass-card p-4">
                            <h3 class="text-sm text-slate-500 mb-1">Last Updated</h3>
                            <p class="text-white">
                                {control.createdAt ? new Date(control.createdAt * 1000).toLocaleDateString() : 'N/A'}
                            </p>
                        </div>
                    </div>
                </>
            )}
        </div>
    </div>
</Layout>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
