---
import Layout from "../../layouts/Layout.astro";
import Navigation from "../../components/Navigation.astro";
import { marked } from "marked";

const { slug } = Astro.params;
const API_URL = "http://localhost:3000";

let page = null;
let contentHtml = "";
let error = null;

if (slug && slug !== "new") {
    try {
        const response = await fetch(`${API_URL}/api/wiki/${slug}`);
        if (response.ok) {
            page = await response.json();
            contentHtml = marked.parse(page.content);
        } else {
            error = "Page not found";
        }
    } catch (e) {
        error = "API connection failed";
    }
}
---

<Layout title={page ? `${page.title} - Wiki` : "Wiki Page"}>
    <Navigation title="Allware Wiki" />

    <main class="pt-24 pb-16 min-h-screen">
        <div class="max-w-4xl mx-auto px-6">
            {
                error ? (
                    <div class="glass-card p-8 border-red-500/50 text-center">
                        <h1 class="text-2xl font-bold text-red-400 mb-4">
                            Error
                        </h1>
                        <p class="text-slate-300">{error}</p>
                        <a href="/wiki" class="btn-secondary mt-6 inline-block">
                            Back to Wiki
                        </a>
                    </div>
                ) : (
                    <article class="glass-card p-8 md:p-12">
                        <header class="mb-8 border-b border-white/10 pb-8">
                            <div class="flex justify-between items-start">
                                <h1 class="text-4xl font-bold text-gradient mb-4">
                                    {page.title}
                                </h1>
                                <a
                                    href={`/wiki/edit/${page.id}`}
                                    class="btn-secondary text-sm"
                                >
                                    Edit Page
                                </a>
                            </div>
                            <div class="text-sm text-slate-400">
                                Last updated:{" "}
                                {new Date(page.updatedAt).toLocaleDateString()}
                            </div>
                        </header>

                        <div
                            class="prose prose-invert max-w-none"
                            set:html={contentHtml}
                        />
                    </article>
                )
            }
        </div>
    </main>
</Layout>
