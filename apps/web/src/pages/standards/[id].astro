---
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
    const API_URL = "http://localhost:3000";
    
    try {
        const response = await fetch(`${API_URL}/api/standards`);
        if (!response.ok) {
            return [];
        }
        
        const standards = await response.json();
        
        return standards.map((standard: any) => ({
            params: { id: standard.id },
        }));
    } catch (error) {
        console.error('Error fetching standards for static paths:', error);
        return [];
    }
}

const { id } = Astro.params;
const API_URL = "http://localhost:3000";

let standard: any = null;
let controls: any[] = [];
let error: string | null = null;

try {
    // Fetch standard details
    const standardResponse = await fetch(`${API_URL}/api/standards/${id}`);
    if (standardResponse.ok) {
        standard = await standardResponse.json();
        
        // Fetch controls for this standard
        const controlsResponse = await fetch(`${API_URL}/api/controls`);
        if (controlsResponse.ok) {
            const allControls = await controlsResponse.json();
            controls = allControls.filter((c: any) => c.standardId === id);
        }
    } else {
        error = "Standard not found";
    }
} catch (e) {
    error = "Failed to load standard";
}
---

<Layout title={standard ? standard.name : "Standard"}>
    <div class="pt-6 md:pt-8 pb-16 min-h-screen px-4 md:px-6">
        <div class="max-w-5xl mx-auto">
            {error ? (
                <div class="glass-card p-6 md:p-8 border-red-500/50">
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-red-400">{error}</span>
                    </div>
                </div>
            ) : standard && (
                <>
                    <!-- Header -->
                    <div class="mb-8">
                        <a href="/standards" class="text-purple-400 hover:text-purple-300 text-sm mb-4 inline-flex items-center gap-2">
                            ‚Üê Back to Standards
                        </a>
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mt-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h1 class="text-2xl md:text-4xl font-bold">{standard.name}</h1>
                                    <span class="badge badge-success text-xs">
                                        {standard.version || 'v1.0'}
                                    </span>
                                </div>
                                <p class="text-slate-400 text-sm md:text-base">{standard.description || 'No description available'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Controls Section -->
                    <div class="glass-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                            <h2 class="text-xl md:text-2xl font-bold">Controls</h2>
                            <a href="/controls" class="btn-primary text-sm active:scale-95 transition-transform">
                                View All Controls
                            </a>
                        </div>

                        {controls.length === 0 ? (
                            <div class="text-center py-12">
                                <svg class="w-12 h-12 md:w-16 md:h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                <p class="text-slate-500 text-sm md:text-base">No controls defined for this standard yet</p>
                            </div>
                        ) : (
                            <div class="space-y-3">
                                {controls.map((control: any) => (
                                    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 hover:bg-slate-800/70 transition-colors">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-blue-400 font-mono text-sm font-bold">{control.code}</span>
                                                    <span class={`badge text-xs ${
                                                        control.status === 'completed' ? 'badge-success' :
                                                        control.status === 'in-progress' ? 'badge-warning' :
                                                        'bg-slate-700 text-slate-400 border-slate-600'
                                                    }`}>
                                                        {control.status || 'pending'}
                                                    </span>
                                                </div>
                                                <h3 class="font-semibold text-white mb-1">{control.title}</h3>
                                                <p class="text-slate-400 text-sm line-clamp-2">{control.description || 'No description'}</p>
                                            </div>
                                            <a 
                                                href={`/controls/${control.id}`}
                                                class="btn-secondary text-xs py-1.5 px-3 whitespace-nowrap active:scale-95 transition-transform"
                                            >
                                                Details
                                            </a>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <!-- Metadata -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                        <div class="glass-card p-4">
                            <h3 class="text-sm text-slate-500 mb-1">Created</h3>
                            <p class="text-white">
                                {standard.createdAt ? new Date(standard.createdAt * 1000).toLocaleDateString() : 'N/A'}
                            </p>
                        </div>
                        <div class="glass-card p-4">
                            <h3 class="text-sm text-slate-500 mb-1">Total Controls</h3>
                            <p class="text-white">{controls.length}</p>
                        </div>
                    </div>
                </>
            )}
        </div>
    </div>
</Layout>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
